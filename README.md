
<!-- markdownlint-disable -->
# Cloudfront S3 redirect Terraform module


<!-- markdownlint-restore -->

[![README Header][readme_header_img]][readme_header_link]

<!--




  ** DO NOT EDIT THIS FILE
  **
  ** This file was automatically generated by the `build-harness`.
  ** 1) Make all changes to `README.yaml`
  ** 2) Run `make init` (you only need to do this once)
  ** 3) Run`make readme` to rebuild this file.
  **
  ** (We maintain HUNDREDS of open source projects. This is how we maintain our sanity.)
  **





-->
An AWS S3 & Cloudfront based solution to redirect domains in a serverless way

---






## Usage

This module deploys and configures a S3 website behind a Cloudfront distribution, allowing you to do a serverless domain name redirect. In order to use this module we assume the following is present:

* it runs HTTPS via Amazon's Certificate Manager ("ACM")
* its domain is backed by a Route53 zone
* and of course, your AWS account provides you access to all these resources necessary.

This module is a pair with
[aws-terraform-module-cloudfront](https://github.com/osodevops/aws-terraform-module-cloudfront),
which handles hosting of a static S3 website with CloudFront and ACM.

Include this repository as a module in your existing terraform code:
```hcl
  # AWS Region for S3 and other resources
  provider "aws" {
    region = "eu-west-2"
    alias = "main"
  }

  # AWS Region for Cloudfront (ACM certs only supports us-east-1)
  provider "aws" {
    region = "us-east-1"
    alias = "cloudfront"
  }

  # Variables
  variable "fqdn" {
    description = "The fully-qualified domain name root of the resulting S3 website."
    default     = "example.com"
  }

  variable "redirect_target" {
    description = "The fully-qualified domain name to redirect to."
    default     = "www.example.com"
  }
```




## Examples

### Using this module
```hcl
  module "main" {
    source = "github.com/osodevops/aws-terraform-module-cloudfront-s3-redirect"

    fqdn = "${var.fqdn}"
    redirect_target = "${var.redirect_target}"
    ssl_certificate_arn = "${aws_acm_certificate_validation.cert.certificate_arn}"

    refer_secret = "${base64sha512("REFER-SECRET-19265125-${var.fqdn}-52865926")}"
    force_destroy = "true"
    priceclass = "PriceClass_200"

    providers = {
      aws.main = aws.main
      aws.cloudfront = aws.cloudfront
    }

    # Optional WAF Web ACL ID, defaults to none.
    web_acl_id = "${data.terraform_remote_state.site.waf-web-acl-id}"
  }

  # ACM Certificate generation

  resource "aws_acm_certificate" "cert" {
    provider          = "aws.cloudfront"
    domain_name       = "${var.fqdn}"
    validation_method = "DNS"
  }

  resource "aws_route53_record" "cert_validation" {
    provider = "aws.cloudfront"
    name     = "${aws_acm_certificate.cert.domain_validation_options.0.resource_record_name}"
    type     = "${aws_acm_certificate.cert.domain_validation_options.0.resource_record_type}"
    zone_id  = "${data.aws_route53_zone.main.id}"
    records  = ["${aws_acm_certificate.cert.domain_validation_options.0.resource_record_value}"]
    ttl      = 60
  }

  resource "aws_acm_certificate_validation" "cert" {
    provider                = "aws.cloudfront"
    certificate_arn         = "${aws_acm_certificate.cert.arn}"
    validation_record_fqdns = ["${aws_route53_record.cert_validation.fqdn}"]
  }

  # Route 53 record for the static site

  data "aws_route53_zone" "main" {
    provider     = "aws.main"
    name         = "${var.fqdn}"
    private_zone = false
  }

  resource "aws_route53_record" "web" {
    provider = "aws.main"
    zone_id  = "${data.aws_route53_zone.main.zone_id}"
    name     = "${var.fqdn}"
    type     = "A"

    alias {
      name    = "${module.main.cf_domain_name}"
      zone_id = "${module.main.cf_hosted_zone_id}"
      evaluate_target_health = false
    }
  }

  # Outputs

  output "s3_bucket_id" {
    value = "${module.main.s3_bucket_id}"
  }

  output "s3_domain" {
    value = "${module.main.s3_website_endpoint}"
  }

  output "s3_hosted_zone_id" {
    value = "${module.main.s3_hosted_zone_id}"
  }

  output "cloudfront_domain" {
    value = "${module.main.cf_domain_name}"
  }

  output "cloudfront_hosted_zone_id" {
    value = "${module.main.cf_hosted_zone_id}"
  }

  output "cloudfront_distribution_id" {
    value = "${module.main.cf_distribution_id}"
  }

  output "route53_fqdn" {
    value = "${aws_route53_record.web.fqdn}"
  }

  output "acm_certificate_arn" {
    value = "${aws_acm_certificate_validation.cert.certificate_arn}"
  }
```

### Inputs

Example module inputs
| Name | Description | Type | Default | Required |
|------|-------------|:----:|:-----:|:-----:|
| aws_region | Region used in AWS | string | n/a | yes |





## Related Projects

Check out these related projects.

- [CloudFront S3 Terraform module](https://github.com/osodevops/aws-terraform-module-cloudfront-s3) - A terraform module for deploying Cloudfront backed by S3



## Need some help

File a GitHub [issue](https://github.com/osodevops/aws-terraform-module-cloudfront-s3-redirect/issues), send us an [email][email] or [tweet us][twitter].

## The legals

Copyright © 2017-2021 [OSO](https://oso.sh) | See [LICENCE](LICENSE) for full details.

[<img src="https://oso-public-resources.s3.eu-west-1.amazonaws.com/oso-logo-green.png" alt="OSO who we are" width="250"/>](https://oso.sh/who-we-are/)

## Who we are

We at [OSO][website] help teams to adopt emerging technologies and solutions to boost their competitiveness, operational excellence and introduce meaningful innovations that drive real business growth. Our developer-first culture, combined with our cross-industry experience and battle-tested delivery methods allow us to implement the most impactful solutions for your business.

Looking for support applying emerging technologies in your business? We’d love to hear from you, get in touch by [email][email]

Start adopting new technologies by checking out [our other projects][github], [follow us on twitter][twitter], [join our team of leaders and challengers][careers], or [contact us][contact] to find the right technology to support your business.[![Beacon][beacon]][website]

  [logo]: https://oso-public-resources.s3.eu-west-1.amazonaws.com/oso-logo-green.png
  [website]: https://oso.sh?utm_source=github&utm_medium=readme&utm_campaign=osodevops/aws-terraform-module-cloudfront-s3-redirect&utm_content=website
  [github]: https://github.com/osodevops?utm_source=github&utm_medium=readme&utm_campaign=osodevops/aws-terraform-module-cloudfront-s3-redirect&utm_content=github
  [careers]: https://oso.sh/careers/?utm_source=github&utm_medium=readme&utm_campaign=osodevops/aws-terraform-module-cloudfront-s3-redirect&utm_content=careers
  [contact]: https://oso.sh/contact/?utm_source=github&utm_medium=readme&utm_campaign=osodevops/aws-terraform-module-cloudfront-s3-redirect&utm_content=contact
  [linkedin]: https://www.linkedin.com/company/oso-devops?utm_source=github&utm_medium=readme&utm_campaign=osodevops/aws-terraform-module-cloudfront-s3-redirect&utm_content=linkedin
  [twitter]: https://twitter.com/osodevops?utm_source=github&utm_medium=readme&utm_campaign=osodevops/aws-terraform-module-cloudfront-s3-redirect&utm_content=twitter
  [email]: mailto:enquiries@oso.sh?utm_source=github&utm_medium=readme&utm_campaign=osodevops/aws-terraform-module-cloudfront-s3-redirect&utm_content=email
  [readme_header_img]: https://oso-public-resources.s3.eu-west-1.amazonaws.com/oso-animation.gif
  [readme_header_link]: https://oso.sh/what-we-do/?utm_source=github&utm_medium=readme&utm_campaign=osodevops/aws-terraform-module-cloudfront-s3-redirect&utm_content=readme_header_link
  [beacon]: https://github-analyics.ew.r.appspot.com/G-WV0Q3HYW08/osodevops/aws-terraform-module-cloudfront-s3-redirect?pixel&cs=github&cm=readme&an=aws-terraform-module-cloudfront-s3-redirect
